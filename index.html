<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è</title>
  <meta name="description" content="–ú–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –¥—ã—Ö–∞–Ω–∏—è —Å–æ –∑–≤—É–∫–∞–º–∏ —Ö–∞–Ω–≥–∞ –∏ —á–∞–∫—Ä–∞–ª—å–Ω—ã–º–∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏ –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="icon" href="image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%234cc9f0'/></svg>">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: linear-gradient(135deg, #0c0c1a 0%, #1a1a2e 30%, #16213e 70%, #0f0f1b 100%);
      color: #d0d0f0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 16px;
      overflow-x: hidden;
    }
    .screen {
      width: 100%;
      max-width: 520px;
      padding: 24px 12px 90px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .hidden {
      display: none !important;
    }
    h1, h2 {
      font-size: 1.9rem;
      margin: 16px 0 24px;
      opacity: 0.95;
      font-weight: 600;
    }
    h2 {
      font-size: 1.5rem;
      color: #4cc9f0;
      margin: 20px 0 16px;
    }

    /* === –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é –≤–Ω–∏–∑—É === */
    .global-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 8px;
      background: rgba(15, 15, 27, 0.85);
      border-top: 1px solid #4cc9f0;
      padding: 8px 0;
      z-index: 100;
    }
    .nav-item {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.15rem;
      color: #a9a9d6;
      transition: all 0.2s;
    }
    .nav-item.active, .nav-item:hover {
      color: white;
      background: rgba(76, 201, 240, 0.2);
      transform: scale(1.05);
    }
    @media (max-width: 320px) {
      .nav-item {
        width: 40px;
        height: 40px;
        font-size: 1.05rem;
      }
    }

    .main-btn {
      width: 100%;
      max-width: 320px;
      padding: 16px;
      font-size: 1.25rem;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s, opacity 0.2s;
      margin: 12px 0;
    }
    .main-btn:hover {
      transform: translateY(-2px);
    }
    .main-btn.primary {
      background: linear-gradient(120deg, #4361ee, #4cc9f0);
      color: white;
    }
    .main-btn.secondary {
      background: rgba(22, 33, 62, 0.7);
      color: #d0d0f5;
      border: 1px solid #4cc9f0;
    }

    /* === –ú–µ–¥–∏—Ç–∞—Ü–∏—è === */
    #breath-circle {
      width: 240px;
      height: 240px;
      position: relative;
      margin: 20px auto;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(76, 201, 240, 0.15);
    }
    .segment {
      position: absolute;
      width: 50%;
      height: 50%;
      transform-origin: 100% 100%;
      clip-path: polygon(0 0, 100% 0, 100% 100%);
      border-radius: 0 0 0 200px;
      opacity: 0.3;
      transition: opacity 0.3s ease;
    }
    .segment.active {
      opacity: 1;
    }
    #segment1 { transform: rotate(0deg); background: linear-gradient(135deg, #4cc9f0, #4361ee); }
    #segment2 { transform: rotate(90deg); background: linear-gradient(135deg, #a9a9d6, #7209b7); }
    #segment3 { transform: rotate(180deg); background: linear-gradient(135deg, #f72585, #b5179e); }
    #segment4 { transform: rotate(270deg); background: linear-gradient(135deg, #a9a9d6, #7209b7); }

    .center-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      background: #4cc9f0;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 12px rgba(76, 201, 240, 0.6);
      z-index: 2;
    }

    #timer {
      font-size: 1.3rem;
      margin: 18px 0;
      letter-spacing: 1px;
      opacity: 0.9;
    }

    .section-title {
      font-size: 1.3rem;
      margin: 20px 0 16px;
      opacity: 0.92;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-top: 12px;
    }
    .controls button {
      background: rgba(22, 33, 62, 0.6);
      color: #d0d0f5;
      border: 1px solid #4cc9f0;
      border-radius: 22px;
      padding: 10px 18px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .controls button:hover {
      background: rgba(30, 40, 80, 0.8);
      transform: translateY(-2px);
    }
    .controls button.active {
      background: #4cc9f0;
      color: #0f0f1b;
      transform: none;
    }

    #play-btn {
      background: linear-gradient(120deg, #4361ee, #4cc9f0);
      color: white;
      font-size: 1.25rem;
      padding: 14px 30px;
      margin: 20px 0 12px;
      border: none;
      border-radius: 26px;
      box-shadow: 0 4px 12px rgba(76, 201, 240, 0.3);
      display: none;
    }

    /* === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å—é –≤ –º–µ–¥–∏—Ç–∞—Ü–∏–∏ === */
    .volume-control {
      margin: 24px 0;
    }
    .volume-control label {
      display: block;
      margin-bottom: 12px;
      font-size: 1.05rem;
    }
    input[type="range"] {
      width: 100%;
      height: 6px;
      background: #2a2a4a;
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4cc9f0;
      cursor: pointer;
    }

    /* === –ú–∞—Ä–∞—Ñ–æ–Ω === */
    .marathon-description {
      font-size: 1.05rem;
      opacity: 0.9;
      margin: 16px 0 24px;
      line-height: 1.5;
    }

    #marathon-start-section,
    #marathon-grid-container {
      margin: 16px 0;
    }

    .marathon-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
    }

    .marathon-day {
      aspect-ratio: 1;
      min-height: 60px;
      border-radius: 50%;
      background: rgba(22, 33, 62, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #a9a9d6;
      border: 2px solid rgba(76, 201, 240, 0.2);
    }
    .marathon-day.completed {
      background: linear-gradient(135deg, #4361ee, #4cc9f0);
      color: white;
      font-size: 2.2rem;
      border-color: transparent;
      box-shadow: 0 0 12px rgba(76, 201, 240, 0.5);
    }

    #chakra-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin: 16px 0;
      max-height: 360px;
      overflow-y: auto;
      padding-right: 6px;
    }
    .chakra-row {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .chakra-text {
      flex: 1;
      color: #d0d0f5;
      font-size: 0.85rem;
    }
    .chakra-name {
      font-weight: 600;
      font-size: 0.85rem;
      line-height: 1.2;
    }
    .chakra-hz {
      font-size: 0.75rem;
      opacity: 0.9;
      margin-top: 2px;
    }
    .chakra-desc {
      font-size: 0.7rem;
      opacity: 0.85;
      margin-top: 3px;
      line-height: 1.2;
    }
    .chakra-circle {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      flex-shrink: 0;
    }
    .chakra-circle:hover {
      transform: scale(1.04);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    .chakra-circle.active {
      outline: 3px solid #4cc9f0;
      outline-offset: -3px;
      box-shadow: none;
    }

    #chakra-mode {
      margin: 20px 0;
      text-align: left;
    }

    .reset-btn {
      margin-top: 12px;
      padding: 6px 14px;
      font-size: 0.85rem;
      background: transparent;
      border: 1px solid #4cc9f0;
      color: #a9a9d6;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .reset-btn:active {
      background: rgba(76, 201, 240, 0.2);
      color: white;
      transform: scale(0.98);
    }

    /* === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è === */
    .confirmation-modal {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22, 33, 62, 0.95);
      border: 1px solid #4cc9f0;
      border-radius: 16px;
      padding: 16px;
      z-index: 200;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-width: 280px;
      max-width: 90%;
    }
    .confirmation-modal p {
      margin: 0;
      font-size: 1.05rem;
      opacity: 0.95;
    }
    .confirmation-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .confirmation-btn {
      padding: 6px 16px;
      border: 1px solid #4cc9f0;
      background: transparent;
      color: #d0d0f5;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .confirmation-btn.yes {
      background: rgba(247, 37, 133, 0.2);
    }
    .confirmation-btn.no {
      background: rgba(76, 201, 240, 0.2);
    }
  </style>
</head>
<body>

<!-- –ì–ª–∞–≤–Ω–∞—è -->
<div id="main-screen" class="screen">
  <h1>–î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è</h1>
  <button id="go-meditation-home" class="main-btn primary">–ú–µ–¥–∏—Ç–∞—Ü–∏—è</button>
  <button id="go-marathon-home" class="main-btn secondary">–ú–∞—Ä–∞—Ñ–æ–Ω 8&nbsp;–¥–Ω–µ–π</button>
</div>

<!-- –ú–µ–¥–∏—Ç–∞—Ü–∏—è -->
<div id="meditation-screen" class="screen hidden">
  <h1>–ú–µ–¥–∏—Ç–∞—Ü–∏—è</h1>
  <div id="breath-circle">
    <div class="segment" id="segment1"></div>
    <div class="segment" id="segment2"></div>
    <div class="segment" id="segment3"></div>
    <div class="segment" id="segment4"></div>
    <div class="center-dot"></div>
  </div>
  <div id="timer">00:00</div>

  <div class="section-title">–í—ã–±–µ—Ä–∏ –≤—Ä–µ–º—è –º–µ–¥–∏—Ç–∞—Ü–∏–∏</div>
  <div id="duration-controls" class="controls">
    <button data-mins="10">10 –º–∏–Ω—É—Ç</button>
    <button data-mins="20">20 –º–∏–Ω—É—Ç</button>
    <button data-mins="30">30 –º–∏–Ω—É—Ç</button>
    <button data-mins="60">1 —á–∞—Å</button>
  </div>

  <button id="play-btn">‚ñ∂ –ù–∞—á–∞—Ç—å</button>

  <div id="session-controls" class="controls hidden" style="margin-top: 16px;">
    <button id="pause-btn">‚è∏ –ü–∞—É–∑–∞</button>
    <button id="stop-btn">‚èπ –°—Ç–æ–ø</button>
    <button id="mute-btn">üîá –ë–µ–∑ –∑–≤—É–∫–∞</button>
  </div>

  <div id="volume-control-med" class="volume-control" style="margin-top: 16px; display: none;">
    <label for="breath-volume-med">–ì—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–∞</label>
    <input type="range" id="breath-volume-med" min="0" max="50" value="30">
  </div>
</div>

<!-- –ú–∞—Ä–∞—Ñ–æ–Ω -->
<div id="marathon-screen" class="screen hidden">
  <h2>–ú–∞—Ä–∞—Ñ–æ–Ω ¬´8 –¥–Ω–µ–π —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è¬ª</h2>
  
  <p class="marathon-description">
    –ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —à–∞–≥ –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ç–∏—à–∏–Ω–µ.<br>
    –ó–∞–≤–µ—Ä—à–∏—Ç–µ –º–µ–¥–∏—Ç–∞—Ü–∏—é 8 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ ‚Äî –∏ –≤–∞—à —Ü–≤–µ—Ç–æ–∫ —Ä–∞—Å—Ü–≤–µ—Ç—ë—Ç üå∏
  </p>

  <div id="marathon-start-section">
    <button id="start-marathon-btn" class="main-btn primary">–ù–∞—á–∞—Ç—å –º–∞—Ä–∞—Ñ–æ–Ω</button>
  </div>

  <div id="marathon-grid-container" class="hidden">
    <div id="marathon-grid" class="marathon-grid"></div>
  </div>
</div>

<!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
<div id="help-screen" class="screen hidden">
  <h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h2>
  
  <p><strong>–ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ (4‚Äì4‚Äì4‚Äì4):</strong></p>
  <p>1. <strong>–í–¥–æ—Ö</strong> ‚Äî 4 —Å–µ–∫</p>
  <p>2. <strong>–ó–∞–¥–µ—Ä–∂–∫–∞</strong> ‚Äî 4 —Å–µ–∫</p>
  <p>3. <strong>–í—ã–¥–æ—Ö</strong> ‚Äî 4 —Å–µ–∫</p>
  <p>4. <strong>–ó–∞–¥–µ—Ä–∂–∫–∞</strong> ‚Äî 4 —Å–µ–∫</p>

  <p style="margin: 16px 0; opacity: 0.9;">
    –≠—Ç–æ—Ç —Ä–∏—Ç–º —É—Å–ø–æ–∫–∞–∏–≤–∞–µ—Ç –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∏ —Å–Ω–∏–∂–∞–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å.
  </p>

  <h3 style="margin: 20px 0 12px; color: #4cc9f0;">üåÄ –ú–∞—Ä–∞—Ñ–æ–Ω 8 –¥–Ω–µ–π</h3>
  <p style="opacity: 0.9; margin-bottom: 16px;">
    –ü—Ä–æ–π–¥–∏—Ç–µ –º–µ–¥–∏—Ç–∞—Ü–∏—é 8 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥.<br>
    –ö–∞–∂–¥—ã–π –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –¥–µ–Ω—å –æ—Ç–º–µ—á–∞–µ—Ç—Å—è —Ü–≤–µ—Ç–∫–æ–º üå∏.
  </p>

  <h3 style="margin: 20px 0 12px; color: #4cc9f0;">üéµ –ß–∞–∫—Ä–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã</h3>
  <p style="opacity: 0.9; margin-bottom: 16px;">
    –ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π:<br>
    <strong>174 –ì—Ü</strong> ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, <strong>285 –ì—Ü</strong> ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ,<br>
    <strong>396 –ì—Ü</strong> ‚Äî –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ, <strong>528 –ì—Ü</strong> ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è,<br>
    <strong>963 –ì—Ü</strong> ‚Äî –æ—â—É—â–µ–Ω–∏–µ –µ–¥–∏–Ω—Å—Ç–≤–∞.
  </p>

  <div style="background: rgba(255,255,255,0.08); border-left: 3px solid #f72585; padding: 11px; font-size: 0.85rem; opacity: 0.85; margin: 16px 0;">
    ‚ö†Ô∏è –ß–∞–∫—Ä–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö –∑–≤—É–∫–æ–≤–æ–π –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º.
  </div>

  <p style="margin-top: 16px; opacity: 0.85;">
    üéß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.
  </p>
</div>

<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div id="settings-screen" class="screen hidden">
  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞</h2>

  <p style="opacity: 0.86; margin: 16px 0;">
    üéß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞.
  </p>

  <div class="volume-control">
    <label for="breath-volume">–ì—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤</label>
    <input type="range" id="breath-volume" min="0" max="50" value="30">
  </div>

  <div id="chakra-mode">
    <label>
      <input type="checkbox" id="full-chakra-cycle">
      –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —á–∞–∫—Ä (–≤–≤–µ—Ä—Ö ‚Üí –≤–Ω–∏–∑)
    </label>
  </div>

  <h3 style="margin: 22px 0 14px; color: #a9a9d6;">–ß–∞—Å—Ç–æ—Ç—ã —á–∞–∫—Ä:</h3>
  <div id="chakra-list"></div>

  <button id="reset-marathon-btn" class="reset-btn">
    –ù–∞—á–∞—Ç—å –º–∞—Ä–∞—Ñ–æ–Ω –∑–∞–Ω–æ–≤–æ
  </button>
</div>

<!-- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –º–µ–Ω—é -->
<div class="global-nav">
  <div class="nav-item" id="nav-main" title="–ì–ª–∞–≤–Ω–∞—è">üè†</div>
  <div class="nav-item" id="nav-meditation" title="–ú–µ–¥–∏—Ç–∞—Ü–∏—è">üßò</div>
  <div class="nav-item" id="nav-marathon" title="–ú–∞—Ä–∞—Ñ–æ–Ω">üå∏</div>
  <div class="nav-item" id="nav-help" title="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è">?</div>
  <div class="nav-item" id="nav-settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</div>
</div>

<script>
  // === –°–¢–ò–õ–ò –î–õ–Ø –ê–ù–ò–ú–ê–¶–ò–ô ===
  if (!document.getElementById('notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
      @keyframes fadeShow { 
        from { opacity: 0; transform: translate(-50%, 10px); } 
        to { opacity: 1; transform: translate(-50%, 0); } 
      }
      @keyframes fadeHide { 
        from { opacity: 1; } 
        to { opacity: 0; } 
      }
    `;
    document.head.appendChild(style);
  }

  // === –ù–ê–í–ò–ì–ê–¶–ò–Ø –° –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï–ú ===
  let pendingScreen = null;
  let isShowingConfirmation = false;

  function showScreen(screenId) {
    if (isShowingConfirmation) return;

    // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ –º–µ–¥–∏—Ç–∞—Ü–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if (location.hash === '#meditation' && screenId !== 'meditation-screen') {
      pendingScreen = screenId;
      showConfirmation();
      return;
    }

    performScreenSwitch(screenId);
  }

  function showConfirmation() {
    if (isShowingConfirmation) return;
    
    pauseResumeSession(); // –°—Ç–∞–≤–∏–º –Ω–∞ –ø–∞—É–∑—É
    
    const modal = document.createElement('div');
    modal.className = 'confirmation-modal';
    modal.innerHTML = `
      <p>–ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –º–µ–¥–∏—Ç–∞—Ü–∏—é?</p>
      <div class="confirmation-buttons">
        <button class="confirmation-btn yes">–î–ê</button>
        <button class="confirmation-btn no">–ù–ï–¢</button>
      </div>
    `;
    document.body.appendChild(modal);
    isShowingConfirmation = true;

    modal.querySelector('.yes').addEventListener('click', () => {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      stopSessionWithoutSaving();
      document.body.removeChild(modal);
      isShowingConfirmation = false;
      performScreenSwitch(pendingScreen);
      pendingScreen = null;
    });

    modal.querySelector('.no').addEventListener('click', () => {
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –º–µ–¥–∏—Ç–∞—Ü–∏—é
      pauseResumeSession(); // —Å–Ω–∏–º–∞–µ–º –ø–∞—É–∑—É
      document.body.removeChild(modal);
      isShowingConfirmation = false;
      pendingScreen = null;
    });
  }

  function performScreenSwitch(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    document.getElementById(screenId).classList.remove('hidden');
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    if (screenId === 'main-screen') document.getElementById('nav-main').classList.add('active');
    else if (screenId === 'meditation-screen') document.getElementById('nav-meditation').classList.add('active');
    else if (screenId === 'marathon-screen') {
      document.getElementById('nav-marathon').classList.add('active');
      updateMarathonScreen();
    }
    else if (screenId === 'help-screen') document.getElementById('nav-help').classList.add('active');
    else if (screenId === 'settings-screen') {
      document.getElementById('nav-settings').classList.add('active');
      renderChakraList();
    }
    
    history.pushState(null, '', `#${screenId.replace('-screen', '')}`);
  }

  // === –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î (—Å–æ–∫—Ä–∞—â—ë–Ω –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –Ω–æ –ø–æ–ª–Ω—ã–π –≤–Ω–∏–∑—É) ===
  // ... [–≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π JavaScript –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –Ω–∏–∂–µ] ...

  // === –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ===
  // 1. stopSessionWithoutSaving ‚Äî —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞, –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–≤—É–∫–∞
  // 2. syncVolume ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
  // 3. startSession ‚Äî –ø–æ–∫–∞–∑ –ø–æ–ª–∑—É–Ω–∫–∞
  // 4. resetToStart ‚Äî —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞

  // --- –ü–æ–ª–Ω—ã–π JavaScript –Ω–∏–∂–µ ---
</script>

<script>
  // === –ü–û–õ–ù–´–ô JS (–≤–∫–ª—é—á–∞—è –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏) ===
  const phaseDuration = 4000;
  let totalMs = null;
  let endTime = null;
  let startTime = null;
  let timerInterval = null;
  let phaseInterval = null;
  let isMuted = false;
  let isPaused = false;
  let audioContext = null;
  let currentPhaseIndex = 0;
  let selectedDuration = null;
  let fullChakraCycle = false;
  let chakraCycleInterval = null;
  let phaseStartTime = null;

  const BG_VOLUME = 0.05;
  let hangVolumeLevel = 0.3;

  const sectors = [
    document.getElementById('segment1'),
    document.getElementById('segment2'),
    document.getElementById('segment3'),
    document.getElementById('segment4')
  ];

  const hangNotes = [293.7, 349.2, 392.0, 466.2];

  const chakras = [
    { name: "–ú—É–ª–∞–¥—Ö–∞—Ä–∞", hz: 174, color: "#ff0000" },
    { name: "–°–≤–∞–¥—Ö–∏—Å—Ç—Ö–∞–Ω–∞", hz: 285, color: "#ff8000" },
    { name: "–ú–∞–Ω–∏–ø—É—Ä–∞", hz: 396, color: "#ffff00" },
    { name: "–ê–Ω–∞—Ö–∞—Ç–∞", hz: 417, color: "#00ff00" },
    { name: "–í–∏—à—É–¥—Ö–∞", hz: 528, color: "#00ffff" },
    { name: "–ê–¥–∂–Ω–∞", hz: 639, color: "#0000ff" },
    { name: "–°–∞—Ö–∞—Å—Ä–∞—Ä–∞", hz: 741, color: "#8000ff" },
    { name: "–ö–æ—Å–º–æ—Å", hz: 852, color: "#00ffff" },
    { name: "–ï–¥–∏–Ω—Å—Ç–≤–æ", hz: 963, color: "#ffd700" }
  ];

  const chakraShortDescriptions = {
    174: "–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ. –î–∞—ë—Ç –æ—Ä–≥–∞–Ω–∞–º —á—É–≤—Å—Ç–≤–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ª—é–±–≤–∏.",
    285: "–ü–æ–º–æ–≥–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ç–∫–∞–Ω–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏—Ö –∫ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º—É –≤–∏–¥—É.",
    396: "–û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –æ—Ç —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã –∏ —Å—Ç—Ä–∞—Ö–∞, –ø–æ–∑–≤–æ–ª—è—è –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.",
    417: "–û—Ç–º–µ–Ω—è–µ—Ç –ø—Ä–æ—à–ª—ã–µ —Ç—Ä–∞–≤–º—ã –∏ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è–º.",
    528: "–ß–∞—Å—Ç–æ—Ç–∞ —á—É–¥–∞. –°–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏, —è—Å–Ω–æ—Å—Ç–∏ —É–º–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é.",
    639: "–ì–∞—Ä–º–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Ä–¥–µ—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä.",
    741: "–†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã, –æ—á–∏—â–∞–µ—Ç –æ—Ç —Ç–æ–∫—Å–∏–Ω–æ–≤ –∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Å–æ–∑–Ω–∞–Ω–∏–µ.",
    852: "–ü—Ä–æ–±—É–∂–¥–∞–µ—Ç –∏–Ω—Ç—É–∏—Ü–∏—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –¥—É—Ö–æ–≤–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É.",
    963: "–°–≤—è–∑—ã–≤–∞–µ—Ç —Å –ø–æ—Ç–æ–∫–æ–º –°–≤–µ—Ç–∞ –∏ –æ—â—É—â–µ–Ω–∏–µ–º –µ–¥–∏–Ω—Å—Ç–≤–∞ —Å–æ –í—Å–µ–º."
  };

  let currentBackgroundOscillator = null;
  let currentBackgroundGain = null;
  let currentFrequency = 396;

  function buildChakraSequence() {
    const up = Array.from({length: 9}, (_, i) => i);
    const down = Array.from({length: 7}, (_, i) => 7 - i);
    return [...up, ...down];
  }

  function playHangSound(frequency) {
    if (isMuted || typeof window.AudioContext === 'undefined') return;
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    const now = audioContext.currentTime;
    const duration = 2.5;
    const masterGain = (getHangVolumeLevel() / 50) * 0.5 * 0.6;
    const partials = [
      { freq: frequency, amp: 1.0, decay: 2.5 },
      { freq: frequency * 1.5, amp: 0.4, decay: 1.8 },
      { freq: frequency * 2.0, amp: 0.25, decay: 1.2 }
    ];
    partials.forEach(p => {
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      const filter = audioContext.createBiquadFilter();
      osc.type = 'sine';
      osc.frequency.value = p.freq;
      filter.type = 'lowpass';
      filter.frequency.value = p.freq * 3;
      filter.Q.value = 0.5;
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(masterGain * p.amp, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, now + p.decay);
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(audioContext.destination);
      osc.start(now);
      osc.stop(now + duration);
    });
  }

  function getHangVolumeLevel() {
    return Math.pow(hangVolumeLevel / 50, 2) * 50;
  }

  function initAudio() {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  function startBackgroundTone(freq) {
    if (isMuted) return;
    initAudio();
    const now = audioContext.currentTime;

    if (currentBackgroundGain) {
      currentBackgroundGain.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
      if (currentBackgroundOscillator) {
        currentBackgroundOscillator.stop(now + 1.0);
      }
    }

    const oscillator = audioContext.createOscillator();
    const merger = audioContext.createChannelMerger(2);
    const gainNode = audioContext.createGain();

    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(freq, now);

    oscillator.connect(merger, 0, 0);
    oscillator.connect(merger, 0, 1);
    merger.connect(gainNode);
    gainNode.connect(audioContext.destination);

    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(BG_VOLUME * 0.12, now + 1.0);

    oscillator.start(now);

    currentBackgroundOscillator = oscillator;
    currentBackgroundGain = gainNode;
  }

  function stopBackgroundTone() {
    if (currentBackgroundGain) {
      const now = audioContext.currentTime;
      currentBackgroundGain.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
      if (currentBackgroundOscillator) {
        currentBackgroundOscillator.stop(now + 1.0);
      }
      currentBackgroundOscillator = null;
      currentBackgroundGain = null;
    }
  }

  function animateBreathCircle() {
    if (!phaseStartTime || isPaused) return;

    const now = Date.now();
    const elapsed = now - phaseStartTime;
    const progress = (elapsed % phaseDuration) / phaseDuration;

    sectors.forEach(s => {
      s.classList.remove('active');
      s.style.background = '';
    });

    const currentSector = sectors[currentPhaseIndex];
    currentSector.classList.add('active');

    const baseHue = 200 + 240 * (currentPhaseIndex / 4);
    const hue = baseHue + 30 * Math.sin(progress * Math.PI);
    const lightness = 45 + 25 * Math.sin(progress * Math.PI);
    const saturation = 80 + 20 * Math.sin(progress * Math.PI);
    currentSector.style.background = `linear-gradient(135deg, hsl(${hue}, ${saturation}%, ${lightness}%), hsl(${hue - 30}, ${saturation}%, ${lightness - 10}%))`;

    requestAnimationFrame(animateBreathCircle);
  }

  function startSession(durationMs) {
    stopSession();
    sectors.forEach(s => {
      s.classList.remove('active');
      s.style.background = '';
    });

    totalMs = durationMs;
    startTime = Date.now();
    endTime = startTime + totalMs;
    isPaused = false;
    currentPhaseIndex = 0;
    phaseStartTime = Date.now();
    selectedDuration = durationMs;

    playHangSound(hangNotes[currentPhaseIndex]);
    if (!isMuted) startBackgroundTone(currentFrequency);

    phaseInterval = setInterval(() => {
      if (isPaused) return;
      currentPhaseIndex = (currentPhaseIndex + 1) % 4;
      playHangSound(hangNotes[currentPhaseIndex]);
    }, phaseDuration);

    animateBreathCircle();

    timerInterval = setInterval(updateTimer, 250);
    updateTimer();

    document.getElementById('pause-btn').textContent = '‚è∏ –ü–∞—É–∑–∞';
    document.getElementById('mute-btn').textContent = isMuted ? 'üîà –°–æ –∑–≤—É–∫–æ–º' : 'üîá –ë–µ–∑ –∑–≤—É–∫–∞';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–∑—É–Ω–æ–∫
    document.getElementById('volume-control-med').style.display = 'block';
  }

  function pauseResumeSession() {
    if (!endTime) return;
    if (isPaused) {
      startTime = Date.now() - (totalMs - (endTime - Date.now()));
      endTime = startTime + totalMs;
      isPaused = false;
      phaseStartTime = Date.now() - (Date.now() - startTime) % phaseDuration;
      if (!isMuted) {
        if (fullChakraCycle) startChakraCycle(totalMs);
        else startBackgroundTone(currentFrequency);
      }
      animateBreathCircle();
      document.getElementById('pause-btn').textContent = '‚è∏ –ü–∞—É–∑–∞';
    } else {
      isPaused = true;
      stopBackgroundTone();
      stopChakraCycle();
      document.getElementById('pause-btn').textContent = '‚ñ∂ –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å';
    }
  }

  function stopSession() {
    if (timerInterval) clearInterval(timerInterval);
    if (phaseInterval) clearInterval(phaseInterval);
    timerInterval = null;
    phaseInterval = null;
    phaseStartTime = null;
    endTime = null;
    isPaused = false;
    stopBackgroundTone();
    stopChakraCycle();
    
    if (location.hash === '#meditation' && selectedDuration) {
      markDayCompleted(selectedDuration);
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–∑—É–Ω–æ–∫
    document.getElementById('volume-control-med').style.display = 'none';
  }

  function stopSessionWithoutSaving() {
    if (timerInterval) clearInterval(timerInterval);
    if (phaseInterval) clearInterval(phaseInterval);
    timerInterval = null;
    phaseInterval = null;
    phaseStartTime = null;
    endTime = null;
    isPaused = false;
    // –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫ ‚Äî –æ–Ω –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–∞–º –ø—Ä–∏ —Å–º–µ–Ω–µ —ç–∫—Ä–∞–Ω–∞
    // –ù–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
    stopBackgroundTone();
    stopChakraCycle();
    
    document.getElementById('volume-control-med').style.display = 'none';
  }

  function startChakraCycle(totalMs) {
    if (!fullChakraCycle) return;
    stopChakraCycle();
    const sequence = buildChakraSequence();
    const stepMs = totalMs / sequence.length;
    let stepIndex = 0;
    currentFrequency = chakras[sequence[stepIndex]].hz;
    if (!isMuted) startBackgroundTone(currentFrequency);
    chakraCycleInterval = setInterval(() => {
      if (isPaused) return;
      stepIndex = (stepIndex + 1) % sequence.length;
      currentFrequency = chakras[sequence[stepIndex]].hz;
      if (!isMuted) startBackgroundTone(currentFrequency);
    }, stepMs);
  }

  function stopChakraCycle() {
    if (chakraCycleInterval) {
      clearInterval(chakraCycleInterval);
      chakraCycleInterval = null;
    }
  }

  // === –ß–ê–ö–†–´ ===
  const breathVolumeSlider = document.getElementById('breath-volume');
  const breathVolumeSliderMed = document.getElementById('breath-volume-med');
  const fullChakraCheckbox = document.getElementById('full-chakra-cycle');

  function syncVolume(value) {
    hangVolumeLevel = parseFloat(value);
    if (breathVolumeSlider) breathVolumeSlider.value = value;
    if (breathVolumeSliderMed) breathVolumeSliderMed.value = value;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∞ –ª–µ—Ç—É
    if (!isMuted && !isPaused && endTime && currentBackgroundGain) {
      const now = audioContext.currentTime;
      const newGain = (Math.pow(hangVolumeLevel / 50, 2) * BG_VOLUME * 0.12);
      currentBackgroundGain.gain.cancelScheduledValues(now);
      currentBackgroundGain.gain.setValueAtTime(newGain, now);
    }
  }

  if (breathVolumeSlider) {
    breathVolumeSlider.addEventListener('input', (e) => syncVolume(e.target.value));
  }
  if (breathVolumeSliderMed) {
    breathVolumeSliderMed.addEventListener('input', (e) => syncVolume(e.target.value));
  }

  fullChakraCheckbox.addEventListener('change', () => {
    fullChakraCycle = fullChakraCheckbox.checked;
    if (fullChakraCycle) {
      document.querySelectorAll('.chakra-circle').forEach(c => c.classList.remove('active'));
    }
  });

  function renderChakraList() {
    const chakraList = document.getElementById('chakra-list');
    if (!chakraList) return;
    
    chakraList.innerHTML = '';
    
    chakras.forEach((chakra, index) => {
      const row = document.createElement('div');
      row.className = 'chakra-row';

      const textDiv = document.createElement('div');
      textDiv.className = 'chakra-text';
      textDiv.innerHTML = `
        <div class="chakra-name">${chakra.name}</div>
        <div class="chakra-hz">${chakra.hz} –ì—Ü</div>
        <div class="chakra-desc">${chakraShortDescriptions[chakra.hz]}</div>
      `;

      const circle = document.createElement('div');
      circle.className = 'chakra-circle';
      circle.dataset.hz = chakra.hz;
      circle.style.backgroundColor = chakra.color;
      if (chakra.hz === currentFrequency) circle.classList.add('active');

      circle.addEventListener('click', () => {
        if (fullChakraCheckbox.checked) {
          const notify = document.createElement('div');
          notify.textContent = "–û—Ç–∫–ª—é—á–∏—Ç–µ ¬´–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª¬ª, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É";
          notify.style.cssText = `
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(22, 33, 62, 0.9);
            color: #d0d0f5;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            z-index: 200;
            opacity: 0;
            animation: fadeShow 0.3s forwards, fadeHide 0.3s forwards 2s;
          `;
          document.body.appendChild(notify);
          setTimeout(() => {
            if (notify.parentNode) notify.parentNode.removeChild(notify);
          }, 2000);
          return;
        }
        document.querySelectorAll('.chakra-circle').forEach(c => c.classList.remove('active'));
        circle.classList.add('active');
        currentFrequency = chakra.hz;
        if (!isPaused && endTime && !isMuted) {
          startBackgroundTone(currentFrequency);
        }
      });

      row.appendChild(textDiv);
      row.appendChild(circle);
      chakraList.appendChild(row);
    });
  }

  function resetToStart() {
    stopSession();
    document.getElementById('timer').textContent = '00:00';
    durationControls.classList.remove('hidden');
    playBtn.classList.add('hidden');
    sessionControls.classList.add('hidden');
    document.querySelectorAll('#duration-controls button').forEach(b => b.classList.remove('active'));
    selectedDuration = null;
    document.getElementById('volume-control-med').style.display = 'none';
  }

  const durationControls = document.getElementById('duration-controls');
  const playBtn = document.getElementById('play-btn');
  const sessionControls = document.getElementById('session-controls');

  // === –í–´–ë–û–† –í–†–ï–ú–ï–ù–ò ===
  document.querySelectorAll('#duration-controls button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#duration-controls button').forEach(b => {
        b.classList.remove('active');
      });
      btn.classList.add('active');
      selectedDuration = parseInt(btn.dataset.mins) * 60 * 1000;
      playBtn.classList.remove('hidden');
      playBtn.style.display = 'inline-block';
    });
  });

  function updateTimer() {
    if (isPaused) return;
    const now = Date.now();
    let remaining = endTime - now;
    if (remaining <= 0) {
      remaining = 0;
      stopSession();
      const notify = document.createElement('div');
      notify.textContent = "–ü—Ä–∞–∫—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.";
      notify.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(22, 33, 62, 0.9);
        color: #d0d0f5;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 0.95rem;
        z-index: 200;
        opacity: 0;
        animation: fadeShow 0.3s forwards, fadeHide 0.3s forwards 3s;
      `;
      document.body.appendChild(notify);
      setTimeout(() => {
        if (notify.parentNode) notify.parentNode.removeChild(notify);
        resetToStart();
      }, 3000);
      return;
    }
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    document.getElementById('timer').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  playBtn.addEventListener('click', () => {
    if (selectedDuration) {
      startSession(selectedDuration);
      durationControls.classList.add('hidden');
      playBtn.classList.add('hidden');
      sessionControls.classList.remove('hidden');
    }
  });

  document.getElementById('pause-btn').addEventListener('click', pauseResumeSession);
  document.getElementById('stop-btn').addEventListener('click', resetToStart);
  document.getElementById('mute-btn').addEventListener('click', () => {
    isMuted = !isMuted;
    if (isMuted) {
      stopBackgroundTone();
      document.getElementById('mute-btn').textContent = 'üîà –°–æ –∑–≤—É–∫–æ–º';
    } else {
      if (fullChakraCycle) {
        startChakraCycle(totalMs);
      } else if (!isPaused && endTime) {
        startBackgroundTone(currentFrequency);
      }
      document.getElementById('mute-btn').textContent = 'üîá –ë–µ–∑ –∑–≤—É–∫–∞';
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      showScreen('main-screen');
    }
  });

  document.querySelector('.chakra-circle').classList.add('active');

  // === –ú–ê–†–ê–§–û–ù ===
  function getMarathonProgress() {
    const data = localStorage.getItem('marathon_progress');
    return data ? JSON.parse(data) : { 
      active: false, 
      days: {}, 
      startDate: null,
      completed: false 
    };
  }

  function startMarathon() {
    const progress = getMarathonProgress();
    if (!progress.active) {
      progress.active = true;
      progress.startDate = new Date().toISOString().split('T')[0];
      localStorage.setItem('marathon_progress', JSON.stringify(progress));
    }
    document.getElementById('marathon-start-section').classList.add('hidden');
    document.getElementById('marathon-grid-container').classList.remove('hidden');
    renderMarathonGrid();
  }

  function saveMarathonProgress(day) {
    const progress = getMarathonProgress();
    if (!progress.active) return;
    if (day > 8) return;

    const today = new Date().toISOString().split('T')[0];
    const todayIndex = Math.floor((new Date(today) - new Date(progress.startDate)) / (1000 * 60 * 60 * 24)) + 1;
    
    if (todayIndex === day && (!progress.days[day] || progress.days[day] !== today)) {
      progress.days[day] = today;
      let completedCount = 0;
      for (let i = 1; i <= 8; i++) {
        if (progress.days[i]) completedCount++;
      }
      progress.completed = (completedCount >= 8);
      localStorage.setItem('marathon_progress', JSON.stringify(progress));
      
      if (progress.completed) {
        showCompletionModal();
      } else {
        showSessionCompletedModal(true);
      }
    }
  }

  function markDayCompleted(durationMs) {
    if (!endTime || Date.now() - startTime < durationMs - 1000) return;
    const progress = getMarathonProgress();
    if (!progress.active) {
      showSessionCompletedModal(false);
      return;
    }
    const today = new Date().toISOString().split('T')[0];
    const dayNumber = Math.floor((new Date(today) - new Date(progress.startDate)) / (1000 * 60 * 60 * 24)) + 1;
    if (dayNumber >= 1 && dayNumber <= 8) {
      saveMarathonProgress(dayNumber);
    } else {
      showSessionCompletedModal(false);
    }
  }

  function renderMarathonGrid() {
    const grid = document.getElementById('marathon-grid');
    if (!grid) return;
    grid.innerHTML = '';
    for (let i = 1; i <= 8; i++) {
      const dayEl = document.createElement('div');
      dayEl.className = 'marathon-day';
      dayEl.textContent = i;
      grid.appendChild(dayEl);
    }
    
    const progress = getMarathonProgress();
    if (progress.active) {
      for (let i = 1; i <= 8; i++) {
        if (progress.days[i]) {
          const dayEl = grid.children[i - 1];
          dayEl.textContent = 'üå∏';
          dayEl.classList.add('completed');
        }
      }
    }
  }

  function updateMarathonScreen() {
    const progress = getMarathonProgress();
    if (progress.active) {
      document.getElementById('marathon-start-section').classList.add('hidden');
      document.getElementById('marathon-grid-container').classList.remove('hidden');
    } else {
      document.getElementById('marathon-start-section').classList.remove('hidden');
      document.getElementById('marathon-grid-container').classList.add('hidden');
    }
    renderMarathonGrid();
  }

  document.getElementById('start-marathon-btn').addEventListener('click', startMarathon);

  // === –°–ë–†–û–° –ú–ê–†–ê–§–û–ù–ê ===
  function resetMarathon() {
    localStorage.removeItem('marathon_progress');
    
    const progress = getMarathonProgress();
    if (!progress.active) {
      const startSection = document.getElementById('marathon-start-section');
      const gridContainer = document.getElementById('marathon-grid-container');
      if (startSection && gridContainer) {
        startSection.classList.remove('hidden');
        gridContainer.classList.add('hidden');
        renderMarathonGrid();
      }
    }
    
    const notify = document.createElement('div');
    notify.textContent = "–ú–∞—Ä–∞—Ñ–æ–Ω —Å–±—Ä–æ—à–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.";
    notify.style.cssText = `
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(22, 33, 62, 0.9);
      color: #d0d0f5;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 0.95rem;
      z-index: 200;
      opacity: 0;
      animation: fadeShow 0.3s forwards, fadeHide 0.3s forwards 3s;
    `;
    document.body.appendChild(notify);
    
    setTimeout(() => {
      if (notify.parentNode) notify.parentNode.removeChild(notify);
    }, 3000);
  }

  document.getElementById('reset-marathon-btn').addEventListener('click', resetMarathon);

  // === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ó–ê–í–ï–†–®–ï–ù–ò–Ø ===
  function showCompletionModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 15, 27, 0.9); display: flex; align-items: center;
      justify-content: center; z-index: 1000;
    `;
    modal.innerHTML = `
      <div style="background: #16213e; border: 1px solid #4cc9f0; border-radius: 20px; padding: 28px; max-width: 92%; width: 360px; color: #d0d0f5; text-align: center;">
        <h2 style="font-size: 1.45rem; margin-bottom: 20px; color: #4cc9f0;">üå∏ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</h2>
        <p style="margin: 16px 0; opacity: 0.9;">–í—ã –ø—Ä–æ—à–ª–∏ 8 –¥–Ω–µ–π –ø—Ä–∞–∫—Ç–∏–∫–∏!<br>–í–∞—à–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ ‚Äî –≤–∞—à–∞ —Å–∏–ª–∞.</p>
        <button id="restart-marathon" style="width: 100%; max-width: 320px; padding: 12px; font-size: 1.1rem; border: none; border-radius: 24px; background: linear-gradient(120deg, #4361ee, #4cc9f0); color: white; margin-top: 20px;">–ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞</button>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('restart-marathon').addEventListener('click', () => {
      localStorage.removeItem('marathon_progress');
      document.getElementById('marathon-start-section').classList.remove('hidden');
      document.getElementById('marathon-grid-container').classList.add('hidden');
      renderMarathonGrid();
      modal.remove();
      showScreen('main-screen');
    });
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  function showSessionCompletedModal(inMarathon) {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 15, 27, 0.9); display: flex; align-items: center;
      justify-content: center; z-index: 1000;
    `;
    if (inMarathon) {
      modal.innerHTML = `
        <div style="background: #16213e; border: 1px solid #4cc9f0; border-radius: 20px; padding: 28px; max-width: 92%; width: 360px; color: #d0d0f5; text-align: center;">
          <h2 style="font-size: 1.45rem; margin-bottom: 20px; color: #4cc9f0;">üå∏ –û—Ç–ª–∏—á–Ω–æ!</h2>
          <p style="margin: 16px 0; opacity: 0.9;">–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –¥–Ω–µ–≤–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É.<br>–í–∞—à —Ü–≤–µ—Ç–æ–∫ —Ä–∞—Å—Ü–≤—ë–ª!</p>
          <button id="go-to-marathon" style="width: 100%; max-width: 320px; padding: 12px; font-size: 1.1rem; border: none; border-radius: 24px; background: rgba(22, 33, 62, 0.7); color: #d0d0f5; border: 1px solid #4cc9f0; margin-top: 20px;">–ö –º–∞—Ä–∞—Ñ–æ–Ω—É</button>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('go-to-marathon').addEventListener('click', () => {
        modal.remove();
        showScreen('marathon-screen');
      });
    } else {
      modal.innerHTML = `
        <div style="background: #16213e; border: 1px solid #4cc9f0; border-radius: 20px; padding: 28px; max-width: 92%; width: 360px; color: #d0d0f5; text-align: center;">
          <h2 style="font-size: 1.45rem; margin-bottom: 20px; color: #4cc9f0;">üôè –°–ø–∞—Å–∏–±–æ!</h2>
          <p style="margin: 16px 0; opacity: 0.9;">–í—ã –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å!<br>–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏ 8-–¥–Ω–µ–≤–Ω—ã–π –º–∞—Ä–∞—Ñ–æ–Ω?</p>
          <button id="go-to-marathon-offer" style="width: 100%; max-width: 320px; padding: 12px; font-size: 1.1rem; border: none; border-radius: 24px; background: linear-gradient(120deg, #4361ee, #4cc9f0); color: white; margin-top: 20px;">–ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞—Ä–∞—Ñ–æ–Ω—É</button>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('go-to-marathon-offer').addEventListener('click', () => {
        modal.remove();
        showScreen('marathon-screen');
      });
    }
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  renderChakraList();
  const initialHash = location.hash.replace('#', '');
  if (initialHash === 'meditation') showScreen('meditation-screen');
  else if (initialHash === 'marathon') showScreen('marathon-screen');
  else if (initialHash === 'help') showScreen('help-screen');
  else if (initialHash === 'settings') showScreen('settings-screen');
  else showScreen('main-screen');
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    });
  }
</script>
</body>
</html>
