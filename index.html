<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–ß–∞–∫—Ä–æ–≤–æ–µ –¥—ã—Ö–∞–Ω–∏–µ –ø–æ –∫–≤–∞–¥—Ä–∞—Ç—É</title>
  <meta name="description" content="–ü—Ä–∞–∫—Ç–∏–∫–∞ —Å –∑–≤—É–∫–∞–º–∏ —Ö–∞–Ω–≥–∞ –∏ —á–∞–∫—Ä–∞–ª—å–Ω—ã–º–∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%234cc9f0'/></svg>">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background-color: #0f0f1b;
      color: #e0e0ff;
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      overflow: hidden;
    }
    #app {
      text-align: center;
      width: 100%;
      max-width: 500px;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 20px;
      opacity: 0.9;
    }

    #breath-circle {
      width: 260px;
      height: 260px;
      position: relative;
      margin: 0 auto 20px;
    }
    .sector {
      position: absolute;
      width: 50%;
      height: 50%;
      transform-origin: 100% 100%;
      clip-path: polygon(0 0, 100% 0, 100% 100%);
      border-radius: 0 0 0 200px;
      background: #1a1a2e;
      opacity: 0.3;
      transition: 
        opacity 0.3s cubic-bezier(0.33, 1, 0.68, 1),
        background-color 0.3s cubic-bezier(0.33, 1, 0.68, 1);
    }
    .sector.active {
      opacity: 1;
    }
    #sector1 { transform: rotate(0deg); background-color: #4cc9f0; }
    #sector2 { transform: rotate(90deg); background-color: #a9a9d6; }
    #sector3 { transform: rotate(180deg); background-color: #f72585; }
    #sector4 { transform: rotate(270deg); background-color: #a9a9d6; }

    #timer {
      font-size: 1.2rem;
      margin: 16px 0;
      letter-spacing: 1px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
    }
    button {
      background: #16213e;
      color: #e0e0ff;
      border: 1px solid #4cc9f0;
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #0f172a;
    }
    button.active {
      background: #4cc9f0;
      color: #0f0f1b;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #play-btn {
      background: #4cc9f0;
      color: #0f0f1b;
      font-size: 1.2rem;
      padding: 10px 24px;
      margin-top: 12px;
      display: none;
    }

    .bottom-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(22, 33, 62, 0.7);
      border: 1px solid #4cc9f0;
      color: #4cc9f0;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .icon-btn:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 15, 27, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .modal.show {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: #16213e;
      border: 1px solid #4cc9f0;
      border-radius: 16px;
      padding: 24px;
      max-width: 90%;
      width: 340px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal h2 {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: #4cc9f0;
      text-align: center;
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #a9a9d6;
      font-size: 1.4rem;
      cursor: pointer;
    }
    .modal-close:hover {
      color: #f72585;
    }

    .volume-control {
      margin-bottom: 20px;
    }
    .volume-control label {
      display: block;
      margin-bottom: 8px;
      font-size: 1.05rem;
    }
    input[type="range"] {
      width: 100%;
      height: 6px;
      background: #2a2a4a;
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4cc9f0;
      cursor: pointer;
    }

    #chakra-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .chakra-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 10px;
      background: rgba(22, 33, 62, 0.4);
      cursor: pointer;
      transition: background 0.2s;
    }
    .chakra-item:hover {
      background: rgba(22, 33, 62, 0.7);
    }
    .chakra-item.active {
      background: rgba(76, 201, 240, 0.2);
      border: 1px solid #4cc9f0;
    }
    .chakra-color {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .chakra-info {
      text-align: left;
      font-size: 0.95rem;
    }
    .chakra-name {
      font-weight: 600;
    }
    .chakra-hz {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    .chakra-desc {
      font-size: 0.78rem;
      opacity: 0.75;
      margin-top: 4px;
    }

    #chakra-mode {
      margin: 16px 0;
      text-align: left;
    }
    #chakra-mode label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    #chakra-mode input {
      accent-color: #4cc9f0;
    }

    #message {
      margin-top: 20px;
      font-size: 1.1rem;
      min-height: 26px;
      opacity: 0;
      transition: opacity 0.5s;
    }
    #message.show {
      opacity: 1;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>–ß–∞–∫—Ä–æ–≤–æ–µ –¥—ã—Ö–∞–Ω–∏–µ –ø–æ –∫–≤–∞–¥—Ä–∞—Ç—É</h1>
    <div id="breath-circle">
      <div class="sector" id="sector1"></div>
      <div class="sector" id="sector2"></div>
      <div class="sector" id="sector3"></div>
      <div class="sector" id="sector4"></div>
    </div>
    <div id="timer">00:00</div>

    <div id="duration-controls" class="controls">
      <button data-mins="10">10 –º–∏–Ω</button>
      <button data-mins="20">20 –º–∏–Ω</button>
      <button data-mins="30">30 –º–∏–Ω</button>
      <button data-mins="60">1 —á–∞—Å</button>
    </div>

    <button id="play-btn">‚ñ∂ –ù–∞—á–∞—Ç—å</button>

    <div id="session-controls" class="controls hidden" style="margin-top: 12px;">
      <button id="pause-btn">‚è∏ –ü–∞—É–∑–∞</button>
      <button id="stop-btn">‚èπ –°—Ç–æ–ø</button>
      <button id="mute-btn">üîá –ë–µ–∑ –∑–≤—É–∫–∞</button>
    </div>

    <div class="bottom-buttons">
      <button id="help-btn" class="icon-btn" aria-label="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è">?</button>
      <button id="settings-btn" class="icon-btn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
    </div>
    <div id="message"></div>
  </div>

  <div id="help-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="help-close">‚úï</button>
      <h2>–ß–∞–∫—Ä–æ–≤–æ–µ –¥—ã—Ö–∞–Ω–∏–µ –ø–æ –∫–≤–∞–¥—Ä–∞—Ç—É</h2>
      <p><strong>4‚Äì4‚Äì4‚Äì4:</strong></p>
      <p>1. <strong>–í–¥–æ—Ö</strong> ‚Äî 4 —Å–µ–∫</p>
      <p>2. <strong>–ó–∞–¥–µ—Ä–∂–∫–∞</strong> ‚Äî 4 —Å–µ–∫</p>
      <p>3. <strong>–í—ã–¥–æ—Ö</strong> ‚Äî 4 —Å–µ–∫</p>
      <p>4. <strong>–ó–∞–¥–µ—Ä–∂–∫–∞</strong> ‚Äî 4 —Å–µ–∫</p>

      <p style="margin-top: 16px; font-size: 0.95rem; opacity: 0.9;">
        –≠—Ç–æ—Ç —Ä–∏—Ç–º —É—Å–ø–æ–∫–∞–∏–≤–∞–µ—Ç –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É, —Å–Ω–∏–∂–∞–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –∏ —É–ª—É—á—à–∞–µ—Ç –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é.
      </p>

      <h3 style="margin: 16px 0 8px; color: #4cc9f0; font-size: 1.1rem;">üåÄ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —á–∞–∫—Ä</h3>
      <p style="font-size: 0.95rem; opacity: 0.9;">
        –í–∫–ª—é—á–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–∂–∏–º ¬´–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —á–∞–∫—Ä¬ª ‚Äî –∑–≤—É–∫ –º—è–≥–∫–æ –ø—Ä–æ–π–¥—ë—Ç –æ—Ç –ø–µ—Ä–≤–æ–π (–ú—É–ª–∞–¥—Ö–∞—Ä–∞) –¥–æ –¥–µ–≤—è—Ç–æ–π (–ï–¥–∏–Ω—Å—Ç–≤–æ) —á–∞–∫—Ä—ã –∏ –æ–±—Ä–∞—Ç–Ω–æ.
      </p>
      <p style="font-size: 0.95rem; opacity: 0.9; margin-bottom: 12px;">
        –¢–∞–∫–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≥–∞—Ä–º–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ —Ü–µ–Ω—Ç—Ä—ã —Ç–µ–ª–∞, —É–≥–ª—É–±–ª—è—è –º–µ–¥–∏—Ç–∞—Ü–∏—é –∏ –æ—â—É—â–µ–Ω–∏–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏.
      </p>

      <div style="
        background: rgba(255, 255, 255, 0.08);
        border-left: 3px solid #f72585;
        padding: 10px;
        font-size: 0.85rem;
        opacity: 0.85;
      ">
        ‚ö†Ô∏è <strong>–í–∞–∂–Ω–æ:</strong> –ß–∞–∫—Ä–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö –∑–≤—É–∫–æ–≤–æ–π –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –∏–ª–∏ —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º. –≠—Ñ—Ñ–µ–∫—Ç—ã —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω—ã –∏ –Ω–µ –∑–∞–º–µ–Ω—è—é—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –ø–æ–º–æ—â—å. –ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ.
      </div>

      <p style="margin-top: 12px; font-size: 0.9rem; opacity: 0.85;">
        üéß –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—É—à–Ω–∏–∫–∏.
      </p>
    </div>
  </div>

  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="settings-close">‚úï</button>
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞</h2>

      <p style="font-size: 0.9rem; opacity: 0.85; margin-bottom: 12px;">
        üéß –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏.
      </p>

      <div class="volume-control">
        <label for="breath-volume">–ì—Ä–æ–º–∫–æ—Å—Ç—å –∑–≤—É–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤</label>
        <input type="range" id="breath-volume" min="0" max="50" value="30">
      </div>

      <div id="chakra-mode">
        <label>
          <input type="checkbox" id="full-chakra-cycle">
          –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —á–∞–∫—Ä (–≤–≤–µ—Ä—Ö –∏ –≤–Ω–∏–∑)
        </label>
      </div>

      <h3 style="margin: 20px 0 12px; color: #a9a9d6;">–ß–∞—Å—Ç–æ—Ç–∞ —Ñ–æ–Ω–∞:</h3>
      <div id="chakra-list"></div>
    </div>
  </div>

  <script>
    const phaseDuration = 4000;
    let totalMs = null;
    let endTime = null;
    let startTime = null;
    let timerInterval = null;
    let phaseInterval = null;
    let isMuted = false;
    let isPaused = false;
    let audioContext = null;
    let currentPhaseIndex = 0;
    let selectedDuration = null;
    let fullChakraCycle = false;
    let chakraCycleInterval = null;

    const BG_VOLUME = 0.1; // 10% –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    let hangVolumeLevel = 0.3;

    const sectors = [
      document.getElementById('sector1'),
      document.getElementById('sector2'),
      document.getElementById('sector3'),
      document.getElementById('sector4')
    ];

    const hangNotes = [293.7, 349.2, 392.0, 466.2];

    const chakras = [
      { name: "–ù—É–ª–µ–≤–∞—è", hz: 174, color: "#ff0000" },
      { name: "–°–≤–∞–¥—Ö–∏—Å—Ç—Ö–∞–Ω–∞", hz: 285, color: "#ff8000" },
      { name: "–ú–∞–Ω–∏–ø—É—Ä–∞", hz: 396, color: "#ffff00" },
      { name: "–ê–Ω–∞—Ö–∞—Ç–∞", hz: 417, color: "#00ff00" },
      { name: "–í–∏—à—É–¥—Ö–∞", hz: 528, color: "#00ffff" },
      { name: "–ê–¥–∂–Ω–∞", hz: 639, color: "#0000ff" },
      { name: "–°–∞—Ö–∞—Å—Ä–∞—Ä–∞", hz: 741, color: "#8000ff" },
      { name: "–ö–æ—Å–º–æ—Å", hz: 852, color: "#00ffff" },
      { name: "–ï–¥–∏–Ω—Å—Ç–≤–æ", hz: 963, color: "linear-gradient(45deg, #ffd700, #ffed00)" }
    ];

    const chakraDescriptions = {
      174: "–°–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç –æ—â—É—â–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∑–∞–∑–µ–º–ª–µ–Ω–∏—è. –ß–∞—Å—Ç–æ—Ç–∞ —É–º–∏—Ä–æ—Ç–≤–æ—Ä–µ–Ω–∏—è.",
      285: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏—é –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.",
      396: "–û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –æ—Ç —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã –∏ —Å—Ç—Ä–∞—Ö–∞, –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.",
      417: "–°–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –ø–µ—Ä–µ–º–µ–Ω–∞–º –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—é –æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ –æ–ø—ã—Ç–∞.",
      528: "–°–≤—è–∑–∞–Ω–∞ —Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, —è—Å–Ω–æ—Å—Ç—å—é —É–º–∞ –∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞.",
      639: "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–∞—Ä–º–æ–Ω–∏—é –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ —Å–µ—Ä–¥–µ—á–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞.",
      741: "–°–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç —Ä–µ—à–µ–Ω–∏—é –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Å–æ–∑–Ω–∞–Ω–∏—è.",
      852: "–ù–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä—å, –ø—Ä–æ–±—É–∂–¥–∞—è –∏–Ω—Ç—É–∏—Ü–∏—é –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–∫–æ–π.",
      963: "–°–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç –æ—â—É—â–µ–Ω–∏—é —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –µ–¥–∏–Ω—Å—Ç–≤–∞ —Å –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–º —Ü–µ–ª—ã–º."
    };

    let currentBackgroundOscillator = null;
    let currentBackgroundGain = null;
    let currentFrequency = 396;

    function buildChakraSequence() {
      const up = Array.from({length: 9}, (_, i) => i);
      const down = Array.from({length: 7}, (_, i) => 7 - i);
      return [...up, ...down];
    }

    function playHangSound(frequency) {
      if (isMuted || typeof window.AudioContext === 'undefined') return;
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      const now = audioContext.currentTime;
      const duration = 2.5;
      const masterGain = (hangVolumeLevel / 50) * 0.5 * 0.6;
      const partials = [
        { freq: frequency, amp: 1.0, decay: 2.5 },
        { freq: frequency * 1.5, amp: 0.4, decay: 1.8 },
        { freq: frequency * 2.0, amp: 0.25, decay: 1.2 }
      ];
      partials.forEach(p => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        const filter = audioContext.createBiquadFilter();
        osc.type = 'sine';
        osc.frequency.value = p.freq;
        filter.type = 'lowpass';
        filter.frequency.value = p.freq * 3;
        filter.Q.value = 0.5;
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(masterGain * p.amp, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, now + p.decay);
        osc.connect(filter);
        filter.connect(gain);
        gain.connect(audioContext.destination);
        osc.start(now);
        osc.stop(now + duration);
      });
    }

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function startBackgroundTone(freq) {
      if (isMuted) return;
      initAudio();
      const now = audioContext.currentTime;

      if (currentBackgroundGain) {
        currentBackgroundGain.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
        if (currentBackgroundOscillator) {
          currentBackgroundOscillator.stop(now + 1.0);
        }
      }

      const oscillator = audioContext.createOscillator();
      const merger = audioContext.createChannelMerger(2);
      const gainNode = audioContext.createGain();

      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(freq, now);

      // –ú–æ–Ω–æ ‚Üí —Å—Ç–µ—Ä–µ–æ (–æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤ L –∏ R)
      oscillator.connect(merger, 0, 0);
      oscillator.connect(merger, 0, 1);
      merger.connect(gainNode);
      gainNode.connect(audioContext.destination);

      gainNode.gain.setValueAtTime(0, now);
      gainNode.gain.linearRampToValueAtTime(BG_VOLUME * 0.12, now + 1.0);

      oscillator.start(now);

      currentBackgroundOscillator = oscillator;
      currentBackgroundGain = gainNode;
    }

    function stopBackgroundTone() {
      if (currentBackgroundGain) {
        const now = audioContext.currentTime;
        currentBackgroundGain.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
        if (currentBackgroundOscillator) {
          currentBackgroundOscillator.stop(now + 1.0);
        }
        currentBackgroundOscillator = null;
        currentBackgroundGain = null;
      }
    }

    function highlightSector(index) {
      sectors.forEach((s, i) => {
        if (i === index) {
          setTimeout(() => s.classList.add('active'), 50);
        } else {
          s.classList.remove('active');
        }
      });
    }

    function startChakraCycle(totalMs) {
      if (!fullChakraCycle) return;
      stopChakraCycle();
      const sequence = buildChakraSequence();
      const stepMs = totalMs / sequence.length;
      let stepIndex = 0;
      currentFrequency = chakras[sequence[stepIndex]].hz;
      if (!isMuted) startBackgroundTone(currentFrequency);
      chakraCycleInterval = setInterval(() => {
        if (isPaused) return;
        stepIndex = (stepIndex + 1) % sequence.length;
        currentFrequency = chakras[sequence[stepIndex]].hz;
        if (!isMuted) startBackgroundTone(currentFrequency);
      }, stepMs);
    }

    function stopChakraCycle() {
      if (chakraCycleInterval) {
        clearInterval(chakraCycleInterval);
        chakraCycleInterval = null;
      }
    }

    const helpModal = document.getElementById('help-modal');
    const settingsModal = document.getElementById('settings-modal');
    const chakraList = document.getElementById('chakra-list');
    const breathVolumeSlider = document.getElementById('breath-volume');
    const fullChakraCheckbox = document.getElementById('full-chakra-cycle');

    chakras.forEach((chakra, index) => {
      const item = document.createElement('div');
      item.className = 'chakra-item';
      if (chakra.hz === currentFrequency) item.classList.add('active');
      item.dataset.hz = chakra.hz;
      
      const colorDiv = document.createElement('div');
      colorDiv.className = 'chakra-color';
      if (chakra.color.includes('gradient')) {
        colorDiv.style.background = chakra.color;
      } else {
        colorDiv.style.backgroundColor = chakra.color;
      }
      
      const infoDiv = document.createElement('div');
      infoDiv.className = 'chakra-info';
      infoDiv.innerHTML = `
        <div class="chakra-name">${chakra.name}</div>
        <div class="chakra-hz">${chakra.hz} –ì—Ü</div>
        <div class="chakra-desc">${chakraDescriptions[chakra.hz]}</div>
      `;
      
      item.appendChild(colorDiv);
      item.appendChild(infoDiv);
      chakraList.appendChild(item);

      item.addEventListener('click', () => {
        if (fullChakraCheckbox.checked) {
          showMessage("–û—Ç–∫–ª—é—á–∏—Ç–µ ¬´–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª¬ª, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —á–∞—Å—Ç–æ—Ç—É");
          return;
        }
        document.querySelectorAll('.chakra-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        currentFrequency = chakra.hz;
        if (!isPaused && endTime && !isMuted) {
          startBackgroundTone(currentFrequency);
        }
      });
    });

    fullChakraCheckbox.addEventListener('change', () => {
      fullChakraCycle = fullChakraCheckbox.checked;
      if (fullChakraCycle) {
        document.querySelectorAll('.chakra-item').forEach(i => i.classList.remove('active'));
      }
    });

    breathVolumeSlider.addEventListener('input', () => {
      hangVolumeLevel = parseFloat(breathVolumeSlider.value);
    });

    function openModal(modal) {
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeModal(modal) {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }

    document.getElementById('help-btn').addEventListener('click', () => openModal(helpModal));
    document.getElementById('help-close').addEventListener('click', () => closeModal(helpModal));
    helpModal.addEventListener('click', (e) => { if (e.target === helpModal) closeModal(helpModal); });

    document.getElementById('settings-btn').addEventListener('click', () => openModal(settingsModal));
    document.getElementById('settings-close').addEventListener('click', () => closeModal(settingsModal));
    settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeModal(settingsModal); });

    const durationControls = document.getElementById('duration-controls');
    const playBtn = document.getElementById('play-btn');
    const sessionControls = document.getElementById('session-controls');

    function startSession(durationMs) {
      stopSession();
      sectors.forEach(s => s.classList.remove('active'));
      document.getElementById('message').classList.remove('show');
      totalMs = durationMs;
      startTime = Date.now();
      endTime = startTime + totalMs;
      isPaused = false;
      currentPhaseIndex = 0;
      highlightSector(currentPhaseIndex);
      playHangSound(hangNotes[currentPhaseIndex]);
      if (fullChakraCycle) {
        startChakraCycle(totalMs);
      } else {
        if (!isMuted) startBackgroundTone(currentFrequency);
      }
      phaseInterval = setInterval(() => {
        if (isPaused) return;
        currentPhaseIndex = (currentPhaseIndex + 1) % 4;
        highlightSector(currentPhaseIndex);
        playHangSound(hangNotes[currentPhaseIndex]);
      }, phaseDuration);
      timerInterval = setInterval(updateTimer, 250);
      updateTimer();
      document.getElementById('pause-btn').textContent = '‚è∏ –ü–∞—É–∑–∞';
      document.getElementById('mute-btn').textContent = isMuted ? 'üîà –°–æ –∑–≤—É–∫–æ–º' : 'üîá –ë–µ–∑ –∑–≤—É–∫–∞';
    }

    function pauseResumeSession() {
      if (!endTime) return;
      if (isPaused) {
        startTime = Date.now() - (totalMs - (endTime - Date.now()));
        endTime = startTime + totalMs;
        isPaused = false;
        if (fullChakraCycle) {
          startChakraCycle(totalMs);
        } else if (!isMuted) {
          startBackgroundTone(currentFrequency);
        }
        document.getElementById('pause-btn').textContent = '‚è∏ –ü–∞—É–∑–∞';
      } else {
        isPaused = true;
        stopBackgroundTone();
        stopChakraCycle();
        document.getElementById('pause-btn').textContent = '‚ñ∂ –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å';
      }
    }

    function stopSession() {
      if (timerInterval) clearInterval(timerInterval);
      if (phaseInterval) clearInterval(phaseInterval);
      timerInterval = null;
      phaseInterval = null;
      endTime = null;
      isPaused = false;
      stopBackgroundTone();
      stopChakraCycle();
    }

    function resetToStart() {
      stopSession();
      sectors.forEach(s => s.classList.remove('active'));
      document.getElementById('timer').textContent = '00:00';
      document.getElementById('message').classList.remove('show');
      durationControls.classList.remove('hidden');
      playBtn.classList.add('hidden');
      sessionControls.classList.add('hidden');
      document.querySelectorAll('#duration-controls button').forEach(b => b.classList.remove('active'));
      selectedDuration = null;
    }

    function updateTimer() {
      if (isPaused) return;
      const now = Date.now();
      let remaining = endTime - now;
      if (remaining <= 0) {
        remaining = 0;
        stopSession();
        showMessage("–ü—Ä–∞–∫—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.");
        setTimeout(resetToStart, 3000);
        return;
      }
      const mins = Math.floor(remaining / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      document.getElementById('timer').textContent = 
        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function showMessage(text) {
      const el = document.getElementById('message');
      el.textContent = text;
      el.classList.add('show');
    }

    document.querySelectorAll('#duration-controls button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#duration-controls button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedDuration = parseInt(btn.dataset.mins) * 60 * 1000;
        playBtn.classList.remove('hidden');
        playBtn.style.display = 'inline-block';
      });
    });

    playBtn.addEventListener('click', () => {
      if (selectedDuration) {
        startSession(selectedDuration);
        durationControls.classList.add('hidden');
        playBtn.classList.add('hidden');
        sessionControls.classList.remove('hidden');
      }
    });

    document.getElementById('pause-btn').addEventListener('click', pauseResumeSession);
    document.getElementById('stop-btn').addEventListener('click', resetToStart);
    document.getElementById('mute-btn').addEventListener('click', () => {
      isMuted = !isMuted;
      if (isMuted) {
        stopBackgroundTone();
        document.getElementById('mute-btn').textContent = 'üîà –°–æ –∑–≤—É–∫–æ–º';
      } else {
        if (fullChakraCycle) {
          startChakraCycle(totalMs);
        } else if (!isPaused && endTime) {
          startBackgroundTone(currentFrequency);
        }
        document.getElementById('mute-btn').textContent = 'üîá –ë–µ–∑ –∑–≤—É–∫–∞';
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (helpModal.classList.contains('show')) closeModal(helpModal);
        if (settingsModal.classList.contains('show')) closeModal(settingsModal);
      }
    });

    document.querySelector('.chakra-item[data-hz="396"]').classList.add('active');
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
